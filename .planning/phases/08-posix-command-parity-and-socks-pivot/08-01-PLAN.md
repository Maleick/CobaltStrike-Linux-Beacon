---
phase: 08-posix-command-parity-and-socks-pivot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [implant-macos/src/commands.c, implant-macos/src/files.c]
autonomous: false
requirements: [MAC-11]
must_haves:
  truths:
    - "ls returns directory contents on macOS including file types"
    - "cd successfully changes process working directory on macOS"
    - "upload writes binary-accurate data to macOS filesystem"
    - "download retrieves binary-accurate data from macOS filesystem"
  artifacts:
    - path: "implant-macos/bin/beacon-macos"
      provides: "Compiled Mach-O ARM64 binary"
  key_links:
    - from: "implant-macos/src/commands.c"
      to: "opendir/readdir"
      via: "list_directory function"
      pattern: "opendir\(PathToList\)"
    - from: "implant-macos/src/commands.c"
      to: "chdir"
      via: "COMMAND_CD handler"
      pattern: "chdir\(dir\)"
---

<objective>
Validate that all core POSIX file and directory commands work correctly on macOS ARM64. 
Ensure the implementation is portable and does not rely on Linux-specific behaviors (like /proc).
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@implant-macos/src/commands.c
@implant-macos/src/files.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify binary integrity and POSIX symbol usage</name>
  <files>implant-macos/bin/beacon-macos</files>
  <action>
    1. Compile the macOS beacon in debug mode: `make -C implant-macos clean debug`.
    2. Verify the output binary is a Mach-O 64-bit executable for arm64.
    3. Use `nm -u implant-macos/bin/beacon-macos` to list undefined symbols.
    4. Confirm absence of Linux-specific symbols: `epoll_create`, `epoll_wait`, `AF_PACKET`.
    5. Confirm presence of expected POSIX symbols: `opendir`, `readdir`, `chdir`, `getcwd`, `fopen`, `fread`, `fwrite`.
  </action>
  <verify>
    nm -u implant-macos/bin/beacon-macos | grep -E "opendir|readdir|chdir|getcwd|fopen"
  </verify>
  <done>Binary is verified to use standard POSIX symbols and no Linux-specific APIs.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Live validation of file commands on macOS</name>
  <what-built>macOS Beacon with cd, ls, upload, download implementations</what-built>
  <how-to-verify>
    1. Execute the beacon on a macOS ARM64 host.
    2. From the Team Server (or using a mock controller), issue the following commands:
       - `pwd`: Confirm current directory.
       - `ls`: Confirm it lists files in the current directory.
       - `cd /tmp`: Confirm directory change.
       - `pwd`: Confirm it shows `/tmp`.
       - `upload [local_file] test_upload.txt`: Confirm file is written to `/tmp/test_upload.txt`.
       - `download test_upload.txt`: Confirm file is retrieved and matches original.
    3. Document any behavioral differences (e.g., path separator handling, error messages).
  </how-to-verify>
  <resume-signal>approved</resume-signal>
  <done>All file commands validated on live macOS session.</done>
</task>

</tasks>

<verification>
Check that `ls`, `cd`, `upload`, and `download` return the same results on macOS as they do on Linux, accounting for filesystem differences.
</verification>

<success_criteria>
- `ls` returns correct directory listing on macOS.
- `cd` works and updates `pwd`.
- `upload` and `download` work for both small and large (>1MB) files.
- Binary contains no `epoll` or other Linux-specific symbols.
</success_criteria>

<output>
After completion, create `.planning/phases/08-posix-command-parity-and-socks-pivot/08-01-SUMMARY.md`
</output>
