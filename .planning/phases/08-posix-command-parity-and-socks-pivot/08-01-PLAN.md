---
phase: 08-posix-command-parity-and-socks-pivot
plan: 01
type: execute
wave: 1
depends_on: [07-03]
files_modified: [implant-macos/headers/commands.h, implant-macos/src/commands.c, implant-macos/src/files.c]
autonomous: true
requirements: [MAC-11]
---

<objective>
Validate and harden core POSIX commands (ls, cd, upload, download) for the macOS ARM64 beacon.

Purpose: Ensure basic file and directory operations work reliably on macOS and follow best practices.
Output: Hardened command implementation and verified execution paths.
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@implant-macos/src/commands.c
@implant-macos/src/files.c
@implant-macos/headers/commands.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Header and Symbol Cleanup</name>
  <files>implant-macos/headers/commands.h</files>
  <action>
    - Add the declaration for `int list_directory(const char *path, uint8_t **output, size_t *output_len);` to `implant-macos/headers/commands.h`.
    - Ensure all command-related functions are consistently declared.
  </action>
  <verify>
    make -C implant-macos clean
    make -C implant-macos
  </verify>
  <done>Commands header is complete and correctly declares all internal command handlers.</done>
</task>

<task type="auto">
  <name>Task 2: Audit and Harden File Operations</name>
  <files>implant-macos/src/commands.c, implant-macos/src/files.c</files>
  <action>
    - Verify `list_directory` correctly handles macOS directory entries (it currently uses `d_name`, which is standard POSIX).
    - Ensure `realpath` in `files.c` is used correctly (macOS `realpath` handles NULL for the second argument since 10.6, but the code currently passes `fullname` buffer).
    - Check for any Linux-specific `stat` field assumptions (none found in initial audit, but confirm during detailed pass).
    - Verify `fopen` modes and error handling are robust.
  </action>
  <verify>
    make -C implant-macos
  </verify>
  <done>File and directory commands are audited for macOS compatibility and robustness.</done>
</task>

<task type="auto">
  <name>Task 3: Local Execution Path Verification</name>
  <files></files>
  <action>
    - Since end-to-end live testing is deferred, perform a thorough static analysis of the execution paths for:
      - COMMAND_FILE_LIST (ls)
      - COMMAND_CD (cd)
      - COMMAND_PWD (pwd)
      - COMMAND_UPLOAD (upload)
      - COMMAND_DOWNLOAD (download)
    - Confirm that no `epoll`, `AF_PACKET`, or `/proc` references exist in any of these paths.
  </action>
  <verify>
    grep -rE "epoll|AF_PACKET|/proc" implant-macos/src/
  </verify>
  <done>Execution paths are verified to be pure POSIX and free of Linux-specific dependencies.</done>
</task>

</tasks>

<verification>
Clean build on macOS ARM64 and zero matches for Linux-specific symbols.
</verification>

<success_criteria>
1. All file/directory commands compile without warnings on macOS.
2. No Linux-specific API calls are present in the command execution paths.
3. list_directory is correctly declared in the shared commands header.
</success_criteria>

<output>
After completion, create `.planning/phases/08-posix-command-parity-and-socks-pivot/08-01-SUMMARY.md`
</output>
