---
phase: 04-security-and-build-hygiene
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified: [implant/src/beacon.c, implant-macos/src/beacon.c, CustomBeacon.cna]
autonomous: true
requirements: [SEC-02]
---

<objective>
Eliminate tracked source code mutation for public key injection.

Purpose: Prevent accidental commits of sensitive key material and ensure a clean working tree.
Output: build-time generated public_key.h included by beacon.c.
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Create header generation script</name>
  <files>generate-payload/GeneratePublicKeyHeader.py</files>
  <action>
    - Create `generate-payload/GeneratePublicKeyHeader.py`.
    - Script takes `publickey.txt` and a target output path (e.g., `implant/generated/public_key.h`).
    - Produces a C header defining `unsigned char BEACON_PUBLIC_KEY[]` and `unsigned int BEACON_PUBLIC_KEY_LEN`.
  </action>
  <verify>
    python3 generate-payload/GeneratePublicKeyHeader.py generate-payload/publickey.txt implant/generated/public_key.h
  </verify>
  <done>Header generation tool is implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Beacon Source</name>
  <files>implant/src/beacon.c, implant-macos/src/beacon.c</files>
  <action>
    - Remove the hardcoded/mutable `BEACON_PUBLIC_KEY` array from `beacon.c` in both platforms.
    - Replace with `#include "public_key.h"`.
    - Ensure the build system correctly resolves the generated path.
  </action>
  <verify>
    make -C implant
    make -C implant-macos
  </verify>
  <done>Beacons now use generated headers for key material.</done>
</task>

<task type="auto">
  <name>Task 3: Update Aggressor Integration</name>
  <files>CustomBeacon.cna</files>
  <action>
    - Update `CustomBeacon.cna` to call `GeneratePublicKeyHeader.py` instead of `InsertPublicKey.py`.
    - Remove the `RemovePublicKey.py` cleanup step from the Aggressor script.
    - Ensure `InsertPublicKey.py` and `RemovePublicKey.py` are no longer used in the main workflow.
  </action>
  <verify>
    Visual check of CNA logic.
  </verify>
  <done>Generation workflow is modernized and non-mutating.</done>
</task>

</tasks>

<verification>
Clean build of both beacons and git status remains clean after generation.
</verification>

<success_criteria>
1. publickey.txt is never injected into tracked .c files.
2. Beacons compile correctly using the generated public_key.h.
3. Git status shows no changes to source files after a generation run.
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-and-build-hygiene/04-02-SUMMARY.md`
</output>
