---
phase: 01-baseline-validation-harness
plan: "03"
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - implant/tests/fixtures/protocol/v1/smoke/cd-task.json
  - implant/tests/fixtures/protocol/v1/smoke/pwd-task.json
  - implant/tests/fixtures/protocol/v1/smoke/sleep-task.json
  - implant/tests/fixtures/protocol/v1/smoke/expected_callbacks.json
  - implant/tests/test_command_smoke.py
  - implant/tests/test_protocol_roundtrip.py
autonomous: true
requirements: ["REL-01"]
user_setup: []
must_haves:
  truths:
    - "Baseline command/protocol flows continue to pass semantic regression checks after harness introduction."
    - "Maintainers can detect compatibility regressions in core command smoke paths using fixture-driven tests."
  artifacts:
    - path: "implant/tests/test_protocol_roundtrip.py"
      provides: "Metadata and packet semantic roundtrip regression checks"
      min_lines: 70
    - path: "implant/tests/test_command_smoke.py"
      provides: "Baseline command-path smoke assertions"
      min_lines: 70
    - path: "implant/tests/fixtures/protocol/v1/smoke/expected_callbacks.json"
      provides: "Expected callback semantics for smoke fixtures"
      contains: "CALLBACK"
  key_links:
    - from: "implant/tests/test_protocol_roundtrip.py"
      to: "implant/tests/fixtures/protocol/v1/smoke/"
      via: "semantic fixture assertions"
      pattern: "fixtures/protocol/v1/smoke"
    - from: "implant/tests/test_command_smoke.py"
      to: "implant/tests/fixtures/protocol/v1/smoke/expected_callbacks.json"
      via: "callback expectation checks"
      pattern: "expected_callbacks\.json"
---

<objective>
Add baseline compatibility smoke coverage for existing command/protocol behavior.

Purpose: Guard current beacon behavior against unintended regressions while enabling future profile/transport work.
Output: Smoke fixture pack plus automated protocol roundtrip and command smoke tests.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-baseline-validation-harness/01-CONTEXT.md
@.planning/phases/01-baseline-validation-harness/01-RESEARCH.md
@.planning/phases/01-baseline-validation-harness/01-01-PLAN.md
@implant/src/beacon.c
@implant/src/commands.c
@implant/src/http.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create baseline smoke fixture set and expected callback contract</name>
  <files>implant/tests/fixtures/protocol/v1/smoke/sleep-task.json, implant/tests/fixtures/protocol/v1/smoke/pwd-task.json, implant/tests/fixtures/protocol/v1/smoke/cd-task.json, implant/tests/fixtures/protocol/v1/smoke/expected_callbacks.json</files>
  <action>Define smoke fixtures representing stable baseline command flows (`sleep`, `pwd`, `cd`) and expected callback semantics. Ensure fixtures encode semantic expectations only and include fixture IDs consistent with deterministic runner output conventions.</action>
  <verify>python3 -m json.tool implant/tests/fixtures/protocol/v1/smoke/expected_callbacks.json >/dev/null</verify>
  <done>Smoke fixtures and expected callback contract exist and are machine-validated.</done>
</task>

<task type="auto">
  <name>Task 2: Implement protocol semantic roundtrip regression tests</name>
  <files>implant/tests/test_protocol_roundtrip.py</files>
  <action>Add automated tests validating metadata and packet semantic roundtrip behavior against canonical smoke fixtures. Focus on semantic equivalence assertions and deterministic failure diagnostics keyed by fixture ID.</action>
  <verify>python3 implant/tests/run_regression.py --suite protocol --mode quick</verify>
  <done>Protocol roundtrip suite enforces semantic equivalence for baseline smoke fixtures.</done>
</task>

<task type="auto">
  <name>Task 3: Implement baseline command smoke regression tests</name>
  <files>implant/tests/test_command_smoke.py</files>
  <action>Add smoke tests for baseline command-path compatibility (sleep/pwd/cd) using expected callback mappings. Ensure tests fail clearly when callback semantics regress and integrate with full-suite mode for CI.</action>
  <verify>python3 implant/tests/run_regression.py --suite smoke --mode full</verify>
  <done>Baseline command smoke suite provides deterministic regression detection for core command flows.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Smoke callback JSON validates via `python3 -m json.tool`
- [ ] `python3 implant/tests/run_regression.py --suite protocol --mode quick` passes
- [ ] `python3 implant/tests/run_regression.py --suite smoke --mode full` passes
</verification>

<success_criteria>

- All tasks completed
- REL-01 baseline semantic compatibility checks are automated for core smoke fixtures
- Existing command-path behavior is regression-protected
- Test output remains deterministic and fixture-addressable
  </success_criteria>

<output>
After completion, create `.planning/phases/01-baseline-validation-harness/01-03-SUMMARY.md`
</output>
