---
phase: 01-baseline-validation-harness
plan: "02"
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - implant/tests/cases/parser_reject_continue.yaml
  - implant/tests/fixtures/protocol/v1/tasks/malformed-empty-payload.bin
  - implant/tests/fixtures/protocol/v1/tasks/malformed-invalid-header.bin
  - implant/tests/fixtures/protocol/v1/tasks/malformed-oversized-length.bin
  - implant/tests/test_task_parser.py
  - implant/src/commands.c
autonomous: true
requirements: ["REL-02"]
user_setup: []
must_haves:
  truths:
    - "Malformed task payload fixtures are rejected through controlled parser paths."
    - "Malformed payload processing does not crash the process and preserves loop continuity expectations."
  artifacts:
    - path: "implant/tests/test_task_parser.py"
      provides: "Automated malformed-task regression assertions"
      min_lines: 80
    - path: "implant/tests/cases/parser_reject_continue.yaml"
      provides: "Expected reject/continue outcomes per malformed case"
      contains: "reject_continue"
    - path: "implant/src/commands.c"
      provides: "Parser safety handling consistent with malformed fixture expectations"
      contains: "validate_task_layout"
  key_links:
    - from: "implant/tests/test_task_parser.py"
      to: "implant/tests/cases/parser_reject_continue.yaml"
      via: "expected outcome loading"
      pattern: "parser_reject_continue\.yaml"
    - from: "implant/tests/test_task_parser.py"
      to: "implant/src/commands.c"
      via: "parser behavior validation"
      pattern: "validate_task_layout|commands_parse_tasks"
---

<objective>
Implement malformed-task parser hardening coverage for REL-02.

Purpose: Ensure parser rejects invalid payloads safely and preserves runtime continuity guarantees.
Output: Malformed payload fixture set, expected outcome matrix, and parser-focused regression tests.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-baseline-validation-harness/01-CONTEXT.md
@.planning/phases/01-baseline-validation-harness/01-RESEARCH.md
@.planning/phases/01-baseline-validation-harness/01-01-PLAN.md
@implant/src/commands.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build malformed-task fixture matrix</name>
  <files>implant/tests/fixtures/protocol/v1/tasks/malformed-empty-payload.bin, implant/tests/fixtures/protocol/v1/tasks/malformed-invalid-header.bin, implant/tests/fixtures/protocol/v1/tasks/malformed-oversized-length.bin, implant/tests/cases/parser_reject_continue.yaml</files>
  <action>Create malformed payload fixtures that cover short header, invalid command id, and impossible length scenarios. Add a YAML matrix that binds each fixture to expected parser outcome (`reject`), expected callback/error classification, and continuity expectation (`continue_loop=true`).</action>
  <verify>python3 -c "import yaml; yaml.safe_load(open('implant/tests/cases/parser_reject_continue.yaml'))"</verify>
  <done>Malformed fixture matrix exists and codifies reject/continue expectations for each case.</done>
</task>

<task type="auto">
  <name>Task 2: Add parser regression tests for reject-and-continue behavior</name>
  <files>implant/tests/test_task_parser.py</files>
  <action>Implement automated tests that run malformed fixtures through parser entrypoints and assert: controlled rejection path, no crash, and continuity signals preserved. Ensure test output remains deterministic and maps failures to fixture IDs.</action>
  <verify>python3 implant/tests/run_regression.py --suite parser --mode quick</verify>
  <done>Parser suite fails on unsafe behavior and passes only when reject-with-continue contract is met.</done>
</task>

<task type="auto">
  <name>Task 3: Align parser guards with fixture expectations</name>
  <files>implant/src/commands.c</files>
  <action>Where tests reveal gaps, apply minimal parser safety adjustments in `commands.c` to preserve existing valid behavior while guaranteeing malformed payload rejection and non-crashing control flow. Avoid introducing new command capabilities.</action>
  <verify>python3 implant/tests/run_regression.py --suite parser --mode full</verify>
  <done>All malformed parser tests pass and baseline valid-task behavior remains unchanged.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Malformed fixture YAML parses and references all malformed fixture files
- [ ] `python3 implant/tests/run_regression.py --suite parser --mode quick` passes
- [ ] `python3 implant/tests/run_regression.py --suite parser --mode full` passes
</verification>

<success_criteria>

- All tasks completed
- REL-02 malformed-task reject/continue behavior is enforced by automated tests
- Parser safety handling is test-backed and deterministic
- No new scope beyond malformed-task hardening
  </success_criteria>

<output>
After completion, create `.planning/phases/01-baseline-validation-harness/01-02-SUMMARY.md`
</output>
