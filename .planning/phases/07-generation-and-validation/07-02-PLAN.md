---
phase: 07-generation-and-validation
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified: [CustomBeacon.cna, implant-macos/src/beacon.c]
autonomous: true
requirements: [MAC-05, MAC-09]
---

<objective>
Enable the macOS build target in the Aggressor script and fix the OS version metadata for macOS beacons to show the marketing version instead of the kernel version.

Purpose: Provide a seamless operator experience for generating macOS payloads and ensure accurate metadata in the Team Server.
Output: Updated CustomBeacon.cna with platform selector and fixed beacon.c version gathering.
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CustomBeacon.cna
@implant-macos/src/beacon.c
@.planning/phases/07-generation-and-validation/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CustomBeacon.cna with platform selection</name>
  <files>CustomBeacon.cna</files>
  <action>
    - Add a "Platform" row to the genBeaconMenu dialog using drow_combobox with options "Linux" and "macOS".
    - Update genPayload callback to extract the platform value.
    - If platform is "macOS":
      - Add "--target macos" to all Python script invocations.
      - Update $ImplantSrcDirectory to point to $CustomBeaconProjectFolder . "/implant-macos/".
      - Update the final "generated at" message to show the correct path for the macOS binary.
    - Ensure the "Linux" path remains functional and uses the existing defaults.
  </action>
  <verify>
    # Visual check of CNA file (since we can't run CS)
    grep "macos" CustomBeacon.cna
    grep "target macos" CustomBeacon.cna
  </verify>
  <done>CustomBeacon.cna supports platform selection and routes build commands to the correct implant tree.</done>
</task>

<task type="auto">
  <name>Task 2: Fix macOS marketing version in beacon.c</name>
  <files>implant-macos/src/beacon.c</files>
  <action>
    - Include <sys/sysctl.h> in implant-macos/src/beacon.c.
    - Implement version gathering using sysctlbyname("kern.osproductversion", ...).
    - Parse the returned string (e.g., "15.0.1") into major and minor integers.
    - Fall back to uname() only if sysctlbyname fails.
    - Update the metadata generation logic to use these values for major/minor version bytes.
  </action>
  <verify>
    # Verify compilation
    make -C implant-macos clean
    make -C implant-macos
  </verify>
  <done>macOS beacon reports marketing version (15.x) instead of kernel version (24.x).</done>
</task>

<task type="auto">
  <name>Task 3: Verify build integration</name>
  <files></files>
  <action>
    - Manually simulate the generation flow for macOS by running the scripts with --target macos and then running make in implant-macos.
    - Confirm the binary is produced in implant-macos/bin/.
  </action>
  <verify>
    make -C implant-macos
    ls -l implant-macos/bin/
  </verify>
  <done>Full macOS build pipeline works end-to-end via manual CLI simulation.</done>
</task>

</tasks>

<verification>
Verify that implant-macos/src/beacon.c compiles cleanly with the new sysctl code. Check CustomBeacon.cna logic for the platform switch.
</verification>

<success_criteria>
1. CustomBeacon.cna presents a platform selector to the operator.
2. macOS selection in CNA correctly triggers macOS-specific build paths.
3. macOS beacon code uses sysctlbyname for OS versioning.
</success_criteria>

<output>
After completion, create `.planning/phases/07-generation-and-validation/07-02-SUMMARY.md`
</output>
