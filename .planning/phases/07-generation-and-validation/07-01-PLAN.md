---
phase: 07-generation-and-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [generate-payload/InsertListenerInfo.py, generate-payload/InsertPublicKey.py, generate-payload/RemovePublicKey.py]
autonomous: true
requirements: [MAC-10]
---

<objective>
Extend the payload generation scripts to support multiple build targets (Linux and macOS) and route generated artifacts to the correct directory tree based on the target.

Purpose: Enable platform-specific artifact generation without cross-polluting directory trees or requiring manual path overrides.
Output: Refactored Python scripts in generate-payload/ with --target support.
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@generate-payload/InsertListenerInfo.py
@generate-payload/InsertPublicKey.py
@generate-payload/RemovePublicKey.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor InsertPublicKey.py and RemovePublicKey.py</name>
  <files>generate-payload/InsertPublicKey.py, generate-payload/RemovePublicKey.py</files>
  <action>
    - Refactor both scripts to use argparse for command-line arguments.
    - Add a --target flag with choices ["linux", "macos"], defaulting to "linux".
    - Replace hardcoded relative paths (../implant/src/beacon.c) with repo-root-relative absolute paths.
    - If target is "macos", path should be "implant-macos/src/beacon.c".
    - If target is "linux", path should be "implant/src/beacon.c".
    - Ensure both scripts verify the existence of the target file before attempting modification.
  </action>
  <verify>
    python3 generate-payload/InsertPublicKey.py --help
    python3 generate-payload/RemovePublicKey.py --help
  </verify>
  <done>Scripts use argparse and support --target flag for path selection.</done>
</task>

<task type="auto">
  <name>Task 2: Update InsertListenerInfo.py for target routing</name>
  <files>generate-payload/InsertListenerInfo.py</files>
  <action>
    - Add --target flag to argparse with choices ["linux", "macos"], defaulting to "linux".
    - Dynamically set GENERATED_DIR, SELECTED_PROFILE_PATH, and GENERATED_HEADER_PATH based on target:
      - linux: "implant/generated"
      - macos: "implant-macos/generated"
    - Ensure the directories are created if they don't exist.
    - Pass the correct output path to render_profile_header.py invocation.
  </action>
  <verify>
    python3 generate-payload/InsertListenerInfo.py --help
    # Test dry run for macos target
    python3 generate-payload/InsertListenerInfo.py 127.0.0.1 443 1 --target macos
  </verify>
  <done>InsertListenerInfo.py routes profile_config.h and selected_profile.json to the target-specific directory.</done>
</task>

<task type="auto">
  <name>Task 3: Validate generation script regression</name>
  <files></files>
  <action>
    - Run all three scripts with --target linux and verify files in implant/ are modified/created.
    - Run all three scripts with --target macos and verify files in implant-macos/ are modified/created.
    - Verify that target "linux" remains the default behavior if no flag is provided.
  </action>
  <verify>
    ls -l implant/generated/profile_config.h
    ls -l implant-macos/generated/profile_config.h
    grep "BEACON_PUBLIC_KEY" implant-macos/src/beacon.c
  </verify>
  <done>All scripts work correctly for both targets and respect defaults.</done>
</task>

</tasks>

<verification>
Check that python3 generate-payload/InsertListenerInfo.py --target macos ... creates implant-macos/generated/profile_config.h and does NOT touch implant/generated/.
</verification>

<success_criteria>
1. All three generation scripts accept --target [linux|macos].
2. macOS target correctly points to implant-macos/ tree.
3. Linux target (default) correctly points to implant/ tree.
</success_criteria>

<output>
After completion, create `.planning/phases/07-generation-and-validation/07-01-SUMMARY.md`
</output>
