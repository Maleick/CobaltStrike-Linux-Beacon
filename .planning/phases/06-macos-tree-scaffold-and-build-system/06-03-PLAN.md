---
phase: 06-macos-tree-scaffold-and-build-system
plan: 03
type: execute
wave: 3
depends_on:
  - 06-01
  - 06-02
files_modified:
  - implant-macos/src/commands.c
autonomous: true
requirements:
  - MAC-01
  - MAC-02

must_haves:
  truths:
    - "implant-macos/src/commands.c has no #include for ELFRunner_include.h"
    - "implant-macos/src/commands.c has no case 200 (BOF execution removed)"
    - "COMMAND_EXECUTE_JOB shell prefix skip of 4+17=21 bytes is preserved unchanged"
    - "make -C implant-macos produces a Mach-O ARM64 binary with zero warnings under -Wall -Wextra"
    - "codesign -dv implant-macos/bin/beacon-macos confirms ad-hoc or linker-signed signature"
    - "file implant-macos/bin/beacon-macos confirms Mach-O 64-bit ARM64 binary"
  artifacts:
    - path: "implant-macos/src/commands.c"
      provides: "macOS task dispatcher without ELFLoader"
      contains: "COMMAND_EXECUTE_JOB"
    - path: "implant-macos/bin/beacon-macos"
      provides: "Compiled Mach-O ARM64 binary"
      min_lines: 1
  key_links:
    - from: "implant-macos/src/commands.c"
      to: "COMMAND_EXECUTE_JOB handler"
      via: "case COMMAND_EXECUTE_JOB: with offset = 4+17"
      pattern: "offset.*17"
    - from: "implant-macos/Makefile"
      to: "implant-macos/bin/beacon-macos"
      via: "clang -arch arm64 link step"
      pattern: "arch arm64"
    - from: "implant-macos/bin/beacon-macos"
      to: "codesign adhoc signature"
      via: "Makefile link target codesign check"
      pattern: "adhoc"
---

<objective>
Write implant-macos/src/commands.c (ELFRunner removal, preserve shell prefix) and then execute
make -C implant-macos to produce the final Mach-O ARM64 binary. Verify the binary's architecture,
code signature, and zero-warning compilation.

This is the integration plan: commands.c is the last rewrite file needed, and its completion
enables the first full build. The verification commands in this plan confirm all five Phase 6
success criteria are met.

Purpose: After this plan completes, Phase 6 is done — a compilable, signed Mach-O ARM64 binary
exists with correct protocol baseline.

Output: implant-macos/src/commands.c + implant-macos/bin/beacon-macos
</objective>

<execution_context>
@/Users/maleick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@.planning/phases/06-macos-tree-scaffold-and-build-system/06-01-SUMMARY.md
@.planning/phases/06-macos-tree-scaffold-and-build-system/06-02-SUMMARY.md

<interfaces>
<!-- Critical source context for the macOS commands.c rewrite. -->
<!-- Read implant/src/commands.c fully before writing implant-macos/src/commands.c. -->

From implant/src/commands.c — sections requiring macOS changes:

1. ELFRunner INCLUDE (line 5) — MUST REMOVE:
   Linux (DO NOT COPY): #include "ELFRunner_include.h"
   macOS: Omit this line entirely. No replacement needed.

2. CASE 200 — BOF EXECUTION (lines ~260-306) — MUST REMOVE:
   The entire case 200: { ... } block including the ELFRunner() call must be removed.
   The switch default case already returns "Unknown command!" which is the correct
   behavior for an unsupported command ID (macOS BOF is out of scope per PROJECT.md).
   Do NOT add a case 200 that returns an error string — just omit the case entirely.

3. COMMAND_EXECUTE_JOB SHELL PREFIX (lines ~308-374) — PRESERVE EXACTLY:
   The current implementation skips 4+17=21 bytes:
   ```c
   int offset = 4; // first 4 bytes seem to be the size of the %COMSPEC%, but I don't actually know what it is for
   offset += 17; // After the 4 byte len at the beginning, the following 17 bytes are %COMSPEC% /C
   int cmd_len = cmd_data_len - offset;
   ```
   This offset logic MUST be preserved verbatim. The Cobalt Strike Team Server sends the
   %COMSPEC% /C prefix regardless of beacon platform — it is server-controlled format.
   HIGH confidence this applies identically to macOS-directed tasks.
   Add a comment noting this is the magic offset: /* CS server-controlled format: 4-byte len + 17-byte %COMSPEC% /C prefix */

4. EVERYTHING ELSE IN commands.c — COPY VERBATIM from implant/src/commands.c:
   - All #include directives EXCEPT "ELFRunner_include.h"
   - extern declarations (g_beacon_state, g_sleep_time_ms, g_jitter_percent)
   - pivot_callback_func() — unchanged
   - send_output_to_server() — unchanged
   - list_directory() — unchanged (POSIX opendir/readdir)
   - commands_parse_tasks() — unchanged (pure C parsing logic)
   - commands_execute() switch — all cases EXCEPT case 200
   - COMMAND_CD, COMMAND_PWD, COMMAND_FILE_LIST — POSIX, unchanged
   - COMMAND_UPLOAD, COMMAND_UPLOAD_CONTINUE — POSIX fopen/fwrite, unchanged
   - COMMAND_DOWNLOAD, COMMAND_CANCEL_DOWNLOAD — calls files.c POSIX code, unchanged
   - COMMAND_LISTEN, COMMAND_CONNECT, COMMAND_SEND, COMMAND_CLOSE — pivot.c POSIX, unchanged
   - COMMAND_DIE — exit(0), unchanged
   - COMMAND_SLEEP — uint32_t arithmetic, unchanged
   - default: case — "Unknown command!" return, unchanged

Commands module structure that is fully POSIX-portable and unchanged:
- All filesystem operations: chdir, getcwd, opendir, readdir, closedir, stat, fopen, fwrite
- All network pivot calls: pivot.c functions (POSIX select-based, copied verbatim in 06-01)
- popen() for shell execution — identical on macOS
- All callback type constants — unchanged (same protocol)
- All command ID constants from commands.h — unchanged (same wire format)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write implant-macos/src/commands.c — remove ELFRunner, preserve shell prefix offset</name>
  <files>
    implant-macos/src/commands.c
  </files>
  <action>
    Read implant/src/commands.c in full first. Write implant-macos/src/commands.c with
    exactly TWO removals (ELFRunner include + case 200) and no other functional changes.

    Begin the file with:
    /* macOS ARM64 rewrite of implant/src/commands.c — last synced 2026-02-26
     * Changes from Linux version:
     *   1. Removed #include "ELFRunner_include.h" — ELFLoader is Linux ELF-specific
     *   2. Removed case 200 (BOF execution) — macOS Mach-O BOF is out of scope (PROJECT.md)
     * COMMAND_EXECUTE_JOB shell prefix offset (4+17=21 bytes) preserved unchanged.
     * All other code is identical to the Linux version.
     */

    REMOVAL 1 — ELFRunner include:
    Do not include the line "#include "ELFRunner_include.h"". Omit it.
    Retain all other #include directives exactly as in the Linux version.

    REMOVAL 2 — Case 200 (BOF):
    Omit the entire "case 200: { ... }" block from the commands_execute() switch.
    The default case in the switch already handles unknown command IDs correctly.
    Do NOT add a placeholder case 200 that returns an error — just omit it entirely.

    PRESERVE — COMMAND_EXECUTE_JOB:
    Copy the case COMMAND_EXECUTE_JOB: handler VERBATIM from the Linux version.
    The 4+17 byte offset must be preserved exactly. Update the inline comment to:
    /* CS server-controlled format: 4-byte len + 17-byte %%COMSPEC%% /C prefix
       This offset is identical for macOS-directed tasks — server format is platform-independent */

    ALL OTHER CODE copies verbatim from implant/src/commands.c. Verify each case from
    the switch statement is present: COMMAND_CD, COMMAND_PWD, COMMAND_FILE_LIST,
    COMMAND_UPLOAD, COMMAND_UPLOAD_CONTINUE, COMMAND_DOWNLOAD, COMMAND_CANCEL_DOWNLOAD,
    COMMAND_LISTEN, COMMAND_CONNECT, COMMAND_SEND, COMMAND_CLOSE, COMMAND_DIE,
    COMMAND_SLEEP, COMMAND_EXECUTE_JOB, default.

    Do NOT add any #ifdef __APPLE__ guards — this file is macOS-only by design.
    Do NOT add any kqueue, epoll, or macOS-specific network code — pivot.c is already
    copied verbatim with its POSIX select()-based implementation.
  </action>
  <verify>
    Run: clang -Wall -Wextra -O2 -arch arm64 \
      -I./implant-macos/headers \
      -I./implant-macos/generated \
      -I$(brew --prefix openssl@3)/include \
      -I$(brew --prefix curl)/include \
      -c implant-macos/src/commands.c \
      -o /tmp/commands-macos.o 2>&1
    Expected: zero output (no warnings, no errors)

    Run: grep -n "ELFRunner" implant-macos/src/commands.c
    Expected: no output

    Run: grep -n "case 200" implant-macos/src/commands.c
    Expected: no output

    Run: grep -n "COMMAND_EXECUTE_JOB" implant-macos/src/commands.c
    Expected: at least one match (case handler preserved)

    Run: grep -n "offset.*17\|17.*offset" implant-macos/src/commands.c
    Expected: at least one match (the 17-byte skip preserved)
  </verify>
  <done>
    implant-macos/src/commands.c compiles clean with zero Clang warnings.
    No ELFRunner include. No case 200. COMMAND_EXECUTE_JOB handler with 4+17 offset present.
    All other command cases present and correct.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run make -C implant-macos and verify the Mach-O ARM64 binary</name>
  <files>
    implant-macos/bin/beacon-macos
  </files>
  <action>
    Execute the full build and verify Phase 6 success criteria. All five source files
    (beacon.c, main.c, commands.c, and the five verbatim copies) are now present in
    implant-macos/src/. The Makefile from Plan 06-01 is ready.

    Step 1 — Generate the generated/profile_config.h stub:
    The Makefile includes -I./generated but the generated/profile_config.h is normally
    written by the generation pipeline (Phase 7). For Phase 6 build verification, create
    a minimal stub that satisfies the preprocessor includes without operator values:
    Write implant-macos/generated/profile_config.h with minimal fallback content:
    ```c
    /* Phase 6 build stub — replaced by InsertListenerInfo.py in Phase 7 */
    /* profile.c falls back to config.h defaults if PROFILE_ID is not defined */
    ```
    This empty stub allows profile.c to fall through to its config.h fallback defines.
    (config.h was copied verbatim from implant/headers/config.h in Plan 06-01.)

    Step 2 — Build:
    Run: make -C implant-macos 2>&1
    Capture full output. The build must complete without errors.
    Warnings are failures — the goal is zero warnings under -Wall -Wextra.

    If the build fails:
    - "No such file or directory" for a header → check that all 9 headers are present in implant-macos/headers/
    - "implicit declaration of function" → check that the relevant header is included in the .c file
    - Homebrew path error → verify brew --prefix openssl@3 returns a path

    Step 3 — Verify the binary:
    Run: file implant-macos/bin/beacon-macos
    Expected output contains: "Mach-O 64-bit executable arm64"

    Run: codesign -dv implant-macos/bin/beacon-macos 2>&1
    Expected: Contains "adhoc" or "linker-signed" — the Apple Clang linker automatically
    applies ad-hoc signing to native ARM64 builds. If the signature is absent or invalid,
    run: codesign --sign - --force implant-macos/bin/beacon-macos
    Then re-verify with codesign -dv.

    Run: otool -L implant-macos/bin/beacon-macos
    Expected: Shows Homebrew libssl, libcrypto, libcurl dylib paths
    (paths should contain /opt/homebrew/ on ARM64 Macs or /usr/local/ on Intel Macs)
    Must NOT show any elfloader or Linux-specific library references.

    Do not attempt to execute the binary — it requires a live Cobalt Strike Team Server
    and a configured profile. Binary execution validation is Phase 7 scope.
  </action>
  <verify>
    Run: make -C implant-macos 2>&1
    Expected: Build completes, last line shows "[+] Build complete: bin/beacon-macos"
    Expected: Zero warning lines (no "warning:" in output)

    Run: file implant-macos/bin/beacon-macos
    Expected: "Mach-O 64-bit executable arm64"

    Run: codesign -dv implant-macos/bin/beacon-macos 2>&1 | grep -i "adhoc\|linker-signed\|flags"
    Expected: non-empty output showing signature flags

    Run: make -C implant-macos 2>&1 | grep -c "warning:"
    Expected: 0

    Run: ls -la implant-macos/bin/beacon-macos
    Expected: file exists, size > 100KB (typical for a statically-linked C binary)
  </verify>
  <done>
    make -C implant-macos produces implant-macos/bin/beacon-macos.
    file confirms Mach-O 64-bit executable arm64.
    codesign -dv confirms ad-hoc or linker-signed signature.
    Zero warnings under -Wall -Wextra.
    All Phase 6 success criteria verifiable.
  </done>
</task>

</tasks>

<verification>
Full Phase 6 success criteria check after both tasks complete:

CRITERION 1 — Clean ARM64 compilation:
  make -C implant-macos 2>&1 | grep -c "warning:" → must be 0
  file implant-macos/bin/beacon-macos → must contain "Mach-O 64-bit executable arm64"

CRITERION 2 — Ad-hoc code signature:
  codesign -dv implant-macos/bin/beacon-macos 2>&1 | grep -i "adhoc\|linker" → non-empty

CRITERION 3 — Dynamic Homebrew path resolution:
  otool -L implant-macos/bin/beacon-macos → Homebrew paths for libssl/libcrypto/libcurl
  grep "brew --prefix" implant-macos/Makefile → two dynamic brew calls present

CRITERION 4 — uint32_t type fix (no /Wimplicit-int-conversion):
  grep "uint32_t var4\|uint32_t var5\|uint32_t var6" implant-macos/src/beacon.c → 3 matches
  make -C implant-macos clean all 2>&1 | grep "implicit-int-conversion" → 0 matches

CRITERION 5 — getprogname() process name:
  grep "getprogname" implant-macos/src/beacon.c → at least 1 match
  grep "proc/self/status" implant-macos/src/beacon.c → 0 matches

EXTRA — No ELFLoader contamination:
  grep -r "ELFRunner\|elfloader" implant-macos/ → 0 matches
</verification>

<success_criteria>
- implant-macos/src/commands.c: no ELFRunner include, no case 200, COMMAND_EXECUTE_JOB with 4+17 offset preserved
- make -C implant-macos produces implant-macos/bin/beacon-macos with zero warnings (MAC-01 satisfied)
- file command confirms Mach-O 64-bit executable arm64
- codesign -dv confirms ad-hoc or linker-signed signature (MAC-02 satisfied)
- otool -L confirms Homebrew library paths (MAC-03 satisfied, confirmed from Plan 06-01 Makefile)
- grep confirms getprogname() in beacon.c (MAC-06 satisfied, confirmed from Plan 06-02)
- grep confirms uint32_t var4/var5/var6 in beacon.c (MAC-04 satisfied, confirmed from Plan 06-02)
- Phase 6 is complete — a compilable macOS ARM64 binary with correct protocol baseline exists
</success_criteria>

<output>
After completion, create .planning/phases/06-macos-tree-scaffold-and-build-system/06-03-SUMMARY.md

In the summary, record:
- Exact build output (any warnings seen and resolved, final binary size)
- codesign -dv output showing signature type
- otool -L output showing Homebrew library paths
- make warning count (should be 0)
- The shell prefix offset value confirmed in commands.c (4+17=21)
</output>
