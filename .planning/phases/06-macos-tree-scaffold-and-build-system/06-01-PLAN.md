---
phase: 06-macos-tree-scaffold-and-build-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - implant-macos/Makefile
  - implant-macos/src/http.c
  - implant-macos/src/crypto.c
  - implant-macos/src/profile.c
  - implant-macos/src/pivot.c
  - implant-macos/src/files.c
  - implant-macos/headers/beacon.h
  - implant-macos/headers/commands.h
  - implant-macos/headers/config.h
  - implant-macos/headers/crypto.h
  - implant-macos/headers/debug.h
  - implant-macos/headers/files.h
  - implant-macos/headers/http.h
  - implant-macos/headers/pivot.h
  - implant-macos/headers/profile.h
  - implant-macos/generated/.gitkeep
autonomous: true
requirements:
  - MAC-01
  - MAC-02
  - MAC-03

must_haves:
  truths:
    - "implant-macos/ directory tree exists with src/, headers/, generated/, bin/, obj/ subdirectories"
    - "Five POSIX-portable source files (http.c, crypto.c, profile.c, pivot.c, files.c) are present as verbatim copies with sync comment header"
    - "All nine header files are present as verbatim copies with sync comment header"
    - "implant-macos/Makefile uses CC=clang, -arch arm64, and resolves Homebrew paths dynamically via brew --prefix"
    - "make -C implant-macos (without rewrite files) does not produce linker errors from missing source files"
  artifacts:
    - path: "implant-macos/Makefile"
      provides: "macOS ARM64 build system with dynamic Homebrew path resolution"
      contains: "brew --prefix openssl@3"
    - path: "implant-macos/src/http.c"
      provides: "libcurl HTTP transport (verbatim copy)"
    - path: "implant-macos/src/crypto.c"
      provides: "OpenSSL EVP crypto layer (verbatim copy)"
    - path: "implant-macos/src/profile.c"
      provides: "Profile schema consumer (verbatim copy)"
    - path: "implant-macos/src/pivot.c"
      provides: "POSIX select()-based SOCKS pivot (verbatim copy)"
    - path: "implant-macos/src/files.c"
      provides: "POSIX file I/O for download/upload (verbatim copy)"
    - path: "implant-macos/headers/beacon.h"
      provides: "beacon_state_t struct and function declarations"
    - path: "implant-macos/generated/.gitkeep"
      provides: "generated/ directory placeholder"
  key_links:
    - from: "implant-macos/Makefile"
      to: "brew --prefix openssl@3"
      via: "$(shell brew --prefix openssl@3)"
      pattern: "brew --prefix"
    - from: "implant-macos/Makefile"
      to: "brew --prefix curl"
      via: "$(shell brew --prefix curl)"
      pattern: "brew --prefix curl"
    - from: "implant-macos/Makefile"
      to: "implant-macos/src/*.c"
      via: "$(wildcard src/*.c)"
      pattern: "wildcard src"
---

<objective>
Scaffold the implant-macos/ directory tree: create all required subdirectories, copy five
POSIX-portable source files verbatim from implant/src/, copy all nine headers verbatim from
implant/headers/, create the generated/ directory placeholder, and write the macOS-specific
Makefile with Apple Clang, -arch arm64, and dynamic Homebrew path resolution.

Purpose: This is the prerequisite for every subsequent plan. Plans 06-02 and 06-03 create the
three rewritten source files (beacon.c, main.c, commands.c) into the tree this plan establishes.
The Makefile written here is the build system that will be exercised in 06-03 verification.

Output: A complete implant-macos/ tree (minus the three rewrite files) with a working Makefile
that will compile to a Mach-O ARM64 binary once 06-02 and 06-03 add the remaining sources.
</objective>

<execution_context>
@/Users/maleick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md
@.planning/research/ARCHITECTURE.md

<interfaces>
<!-- Key source patterns extracted from implant/ tree. Use these for verbatim copy guidance. -->
<!-- Verbatim copies: add sync comment at top of each file, then copy content exactly. -->

Linux Makefile structure (implant/Makefile) — reference for macOS adaptation:
- CC = gcc (change to clang)
- CFLAGS includes -I./headers -I./generated -I./elfloader/elfloader-headers (remove elfloader)
- SOURCES includes $(wildcard elfloader/...) (remove entirely)
- No ELFLoader in macOS build
- All $(wildcard src/*.c) pattern retained

Files to copy VERBATIM (no code changes, add sync comment header only):
- implant/src/http.c      → implant-macos/src/http.c
- implant/src/crypto.c    → implant-macos/src/crypto.c
- implant/src/profile.c   → implant-macos/src/profile.c
- implant/src/pivot.c     → implant-macos/src/pivot.c
- implant/src/files.c     → implant-macos/src/files.c
- implant/headers/*.h (all 9) → implant-macos/headers/

Sync comment format (add as first line of each verbatim-copied file):
/* copied from implant/src/<filename>, last synced 2026-02-26 */

Files NOT in this plan (created in 06-02 and 06-03):
- implant-macos/src/beacon.c  (macOS rewrite — Plan 06-02)
- implant-macos/src/main.c    (cosmetic rewrite — Plan 06-02)
- implant-macos/src/commands.c (ELFRunner removal — Plan 06-03)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory scaffold and copy verbatim source/header files</name>
  <files>
    implant-macos/src/http.c
    implant-macos/src/crypto.c
    implant-macos/src/profile.c
    implant-macos/src/pivot.c
    implant-macos/src/files.c
    implant-macos/headers/beacon.h
    implant-macos/headers/commands.h
    implant-macos/headers/config.h
    implant-macos/headers/crypto.h
    implant-macos/headers/debug.h
    implant-macos/headers/files.h
    implant-macos/headers/http.h
    implant-macos/headers/pivot.h
    implant-macos/headers/profile.h
    implant-macos/generated/.gitkeep
  </files>
  <action>
    Create the implant-macos/ directory tree with these subdirectories:
      implant-macos/src/
      implant-macos/headers/
      implant-macos/generated/
      implant-macos/bin/
      implant-macos/obj/

    For each of the five POSIX-portable source files, copy the content verbatim from the
    corresponding implant/src/ file, prepending exactly this sync comment as the first line:
      /* copied from implant/src/http.c, last synced 2026-02-26 */
    (adjust filename for each file)

    Source files to copy verbatim:
      implant/src/http.c     → implant-macos/src/http.c
      implant/src/crypto.c   → implant-macos/src/crypto.c
      implant/src/profile.c  → implant-macos/src/profile.c
      implant/src/pivot.c    → implant-macos/src/pivot.c
      implant/src/files.c    → implant-macos/src/files.c

    For each of the nine header files, copy the content verbatim from implant/headers/,
    prepending the sync comment as the first line:
      /* copied from implant/headers/beacon.h, last synced 2026-02-26 */
    (adjust filename for each header)

    Headers to copy verbatim (all files in implant/headers/):
      beacon.h, commands.h, config.h, crypto.h, debug.h,
      files.h, http.h, pivot.h, profile.h

    Create implant-macos/generated/.gitkeep (empty file) to preserve the generated/
    directory in git. The actual profile_config.h will be written here by the generation
    pipeline — the directory must exist for the Makefile's -I./generated to work.

    IMPORTANT: Do NOT create beacon.c, main.c, or commands.c in this task. Those are
    macOS-specific rewrites handled in Plans 06-02 and 06-03.
    Do NOT create any elfloader/ directory or copy any ELFLoader files.
  </action>
  <verify>
    Run: ls implant-macos/src/ implant-macos/headers/ implant-macos/generated/
    Expected: src/ contains http.c crypto.c profile.c pivot.c files.c (no beacon.c, commands.c, main.c yet)
    Expected: headers/ contains all 9 .h files
    Expected: generated/ contains .gitkeep
    Run: head -1 implant-macos/src/http.c
    Expected: /* copied from implant/src/http.c, last synced 2026-02-26 */
  </verify>
  <done>
    Five source files and nine headers exist in implant-macos/ with sync comment headers.
    generated/.gitkeep exists. No ELFLoader or elfloader/ directory present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write implant-macos/Makefile with Apple Clang and dynamic Homebrew path resolution</name>
  <files>
    implant-macos/Makefile
  </files>
  <action>
    Write implant-macos/Makefile with the following exact structure. Do not hardcode
    /opt/homebrew or /usr/local — use brew --prefix to resolve paths dynamically so
    the Makefile works on both ARM64 and Intel Homebrew installs.

    Required Makefile content:

    ```makefile
    # Makefile for Cobalt Strike macOS ARM64 Implant
    # Build host: macOS ARM64 (Apple Silicon M1-M4)
    # Compiler: Apple Clang (Xcode Command Line Tools)
    # Dependencies: Homebrew openssl@3, Homebrew curl

    OUTPUT ?= beacon-macos

    CC = clang

    BREW_OPENSSL := $(shell brew --prefix openssl@3 2>/dev/null)
    BREW_CURL    := $(shell brew --prefix curl 2>/dev/null)

    CFLAGS = -Wall -Wextra -O2 \
             -arch arm64 \
             -mmacosx-version-min=12.0 \
             -I./headers \
             -I./generated \
             -I$(BREW_OPENSSL)/include \
             -I$(BREW_CURL)/include

    LDFLAGS = -L$(BREW_OPENSSL)/lib \
              -L$(BREW_CURL)/lib \
              -lssl -lcrypto -lcurl

    # Directories
    SRC_DIR = src
    INC_DIR = headers
    OBJ_DIR = obj
    BIN_DIR = bin

    # Target binary
    TARGET = $(BIN_DIR)/$(OUTPUT)
    MAKEFILE_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

    # macOS source files only — no ELFLoader
    SOURCES = $(wildcard $(SRC_DIR)/*.c)

    # Object files (mirror source tree in obj/)
    OBJECTS = $(patsubst %.c,$(OBJ_DIR)/%.o,$(SOURCES))

    # Default target
    all: check-deps directories $(TARGET)

    # Verify Homebrew dependencies are available
    check-deps:
    	@if [ -z "$(BREW_OPENSSL)" ]; then \
    		echo "[ERROR] openssl@3 not found. Run: brew install openssl@3"; \
    		exit 1; \
    	fi
    	@if [ -z "$(BREW_CURL)" ]; then \
    		echo "[ERROR] Homebrew curl not found. Run: brew install curl"; \
    		exit 1; \
    	fi

    # Create necessary directories
    directories:
    	@mkdir -p $(BIN_DIR)
    	@mkdir -p $(OBJ_DIR)/$(SRC_DIR)
    	@mkdir -p generated

    # Link the final binary
    $(TARGET): $(OBJECTS)
    	@echo "[LD] Linking $@"
    	@$(CC) -arch arm64 $(OBJECTS) -o $@ $(LDFLAGS)
    	@echo "[+] Build complete: $@"
    	@echo "[+] Verifying ad-hoc code signature..."
    	@codesign -dv $@ 2>&1 | grep -q "adhoc" && echo "[+] Ad-hoc signature present" || (codesign --sign - --force $@ && echo "[+] Ad-hoc signature applied")

    # Compile source files
    $(OBJ_DIR)/%.o: %.c
    	@echo "[CC] Compiling $<"
    	@$(CC) $(CFLAGS) -c $< -o $@

    # Clean build artifacts
    clean:
    	@echo "[CLEAN] Removing build artifacts"
    	@rm -rf $(OBJ_DIR) $(BIN_DIR)

    # Debug build (includes DEBUG macro for DEBUG_PRINT output)
    debug: CFLAGS += -g -DDEBUG
    debug: clean all

    .PHONY: all clean debug directories check-deps
    ```

    Critical requirements:
    - CC = clang (not gcc)
    - -arch arm64 present in both CFLAGS and link step
    - -mmacosx-version-min=12.0 for maximum Apple Silicon compatibility
    - BREW_OPENSSL and BREW_CURL use $(shell brew --prefix ...) — no hardcoded paths
    - SOURCES = $(wildcard $(SRC_DIR)/*.c) — picks up all .c files in src/ with no elfloader reference
    - Ad-hoc signing check in the link target — checks if linker already signed, applies explicit codesign if not
    - check-deps target fails fast with human-readable error if Homebrew deps missing
    - No elfloader/ directory references anywhere in the Makefile
    - Tab-indented recipe lines (Makefile requirement — use actual tabs, not spaces)
  </action>
  <verify>
    Run: make -C implant-macos check-deps
    Expected: exits 0 (Homebrew openssl@3 and curl are installed on the build host per STACK.md research)

    Run: grep "brew --prefix" implant-macos/Makefile
    Expected: Two lines — one for openssl@3, one for curl

    Run: grep -i "elfloader\|elf_loader" implant-macos/Makefile
    Expected: no output (no ELFLoader references)

    Run: grep "arch arm64" implant-macos/Makefile
    Expected: appears in CFLAGS and link step

    Run: make -C implant-macos 2>&1 | head -5
    Expected: compilation errors about missing beacon.c, main.c, commands.c (not linker/Homebrew errors)
    This confirms the Makefile itself is syntactically valid and Homebrew paths resolve correctly.
  </verify>
  <done>
    implant-macos/Makefile exists with dynamic Homebrew path resolution, -arch arm64, Apple Clang,
    ad-hoc signing check, and no ELFLoader references. make check-deps passes. make fails only
    because beacon.c / main.c / commands.c are not yet present (expected at this stage).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Directory structure check:
   ls implant-macos/src/ — must show: http.c crypto.c profile.c pivot.c files.c (exactly 5 files, no beacon.c/main.c/commands.c)
   ls implant-macos/headers/ — must show all 9 .h files
   ls implant-macos/generated/ — must show .gitkeep

2. Sync comments present:
   head -1 implant-macos/src/http.c — must match sync comment format

3. Makefile validity:
   make -C implant-macos check-deps — must exit 0
   grep "brew --prefix" implant-macos/Makefile — must find dynamic path resolution
   grep "elfloader" implant-macos/Makefile — must return nothing

4. No cross-tree include paths:
   grep -r "implant/headers\|implant/src" implant-macos/ — must return nothing
   (each tree is self-contained — no symlinks or cross-tree -I paths)
</verification>

<success_criteria>
- implant-macos/ tree has all directories, 5 verbatim source files, 9 verbatim headers, generated/.gitkeep
- implant-macos/Makefile uses CC=clang, -arch arm64, dynamic brew --prefix for OpenSSL and curl
- make -C implant-macos check-deps exits 0
- make -C implant-macos fails only on missing beacon.c/main.c/commands.c (not on Makefile errors or Homebrew paths)
- No ELFLoader references anywhere in implant-macos/ tree
- MAC-01: Compilation infrastructure ready for -Wall -Wextra -O2 ARM64 build
- MAC-02: Ad-hoc signing step present in Makefile link target
- MAC-03: Homebrew paths resolved dynamically via brew --prefix
</success_criteria>

<output>
After completion, create .planning/phases/06-macos-tree-scaffold-and-build-system/06-01-SUMMARY.md
</output>
