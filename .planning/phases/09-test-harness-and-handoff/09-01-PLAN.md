---
phase: 09-test-harness-and-handoff
plan: 01
type: execute
wave: 1
depends_on: [08-02]
files_modified: [implant-macos/tests/run_regression.py, implant-macos/tests/fixture_index.json]
autonomous: true
requirements: [MAC-13]
---

<objective>
Adapt the Linux regression test harness for the macOS ARM64 beacon.

Purpose: Ensure protocol and metadata consistency on macOS through automated fixture testing.
Output: Working test harness in implant-macos/tests/ passing for macOS-specific fixtures.
</objective>

<execution_context>
@/Users/maleick/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@implant/tests/run_regression.py
@implant/tests/fixture_index.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold macOS Test Tree</name>
  <files>implant-macos/tests/</files>
  <action>
    - Create the `implant-macos/tests/` directory.
    - Copy `run_regression.py`, `test_task_parser.py`, `test_protocol_roundtrip.py`, and `test_command_smoke.py` from `implant/tests/`.
    - Create a macOS-specific `fixture_index.json` that includes:
      - Reused protocol fixtures from `implant/tests/fixtures/protocol/`.
      - New macOS-specific metadata fixtures covering `getprogname()` and `sysctlbyname()` outputs.
  </action>
  <verify>
    ls -R implant-macos/tests/
  </verify>
  <done>macOS test tree is scaffolded with necessary scripts and initial index.</done>
</task>

<task type="auto">
  <name>Task 2: Update Test Runners for macOS</name>
  <files>implant-macos/tests/test_task_parser.py, implant-macos/tests/test_command_smoke.py</files>
  <action>
    - Update paths in test runners to point to `implant-macos/` source files instead of `implant/`.
    - Remove any references to `ELFRunner` or Linux-specific parser cases (like case 200).
    - Ensure `test_command_smoke.py` uses the correct 21-byte shell offset for macOS.
  </action>
  <verify>
    python3 implant-macos/tests/run_regression.py --dry-run
  </verify>
  <done>Test runners are updated to target the macOS beacon source.</done>
</task>

<task type="auto">
  <name>Task 3: Execute macOS Regression Suite</name>
  <files></files>
  <action>
    - Run the full regression suite on the current macOS ARM64 host.
    - Verify that all protocol and metadata fixtures pass.
    - Document any necessary adjustments to the fixture corpus for macOS parity.
  </action>
  <verify>
    python3 implant-macos/tests/run_regression.py --mode quick
  </verify>
  <done>macOS regression suite passes with 100% success on ARM64.</done>
</task>

</tasks>

<verification>
implant-macos/tests/run_regression.py passes all checks for the macOS binary.
</verification>

<success_criteria>
1. Test harness successfully executes on macOS ARM64.
2. Protocol fixtures are verified consistent between Linux and macOS.
3. macOS-specific metadata (OS version, process name) is correctly validated.
</success_criteria>

<output>
After completion, create `.planning/phases/09-test-harness-and-handoff/09-01-SUMMARY.md`
</output>
