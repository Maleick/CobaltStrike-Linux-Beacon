---
phase: 02-http-s-profile-abstraction
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - profiles/http/default-profile.json
  - profiles/http/nondefault-profile.json
  - generate-payload/validate_profile.py
  - generate-payload/render_profile_header.py
  - generate-payload/InsertListenerInfo.py
  - CustomBeacon.cna
autonomous: true
requirements: ["C2P-01", "C2P-03"]
user_setup: []
must_haves:
  truths:
    - "Operator can select a profile artifact during generation without editing tracked C source/header files."
    - "Profile artifacts are validated before compilation with deterministic failures on invalid input."
  artifacts:
    - path: "profiles/http/default-profile.json"
      provides: "Canonical baseline HTTP/S profile artifact"
      contains: "schema_version"
    - path: "generate-payload/validate_profile.py"
      provides: "Strict profile validation gate for generation path"
      min_lines: 60
    - path: "generate-payload/render_profile_header.py"
      provides: "Deterministic profile-to-build artifact renderer"
      min_lines: 80
  key_links:
    - from: "CustomBeacon.cna"
      to: "generate-payload/validate_profile.py"
      via: "generation pre-build validation"
      pattern: "validate_profile\.py"
    - from: "CustomBeacon.cna"
      to: "generate-payload/render_profile_header.py"
      via: "selected profile artifact rendering"
      pattern: "render_profile_header\.py"
---

<objective>
Define the Phase 2 profile artifact contract and generation integration entrypoint.

Purpose: Replace ad-hoc source mutation workflow for profile values with versioned profile artifacts and deterministic validation/rendering in existing operator flow.
Output: Profile JSON artifacts, validation/render scripts, and generation workflow wiring for profile selection.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/02-http-s-profile-abstraction/02-CONTEXT.md
@.planning/phases/02-http-s-profile-abstraction/02-RESEARCH.md
@CustomBeacon.cna
@generate-payload/InsertListenerInfo.py
@implant/headers/config.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define versioned HTTP/S profile artifacts</name>
  <files>profiles/http/default-profile.json, profiles/http/nondefault-profile.json</files>
  <action>Create versioned JSON profile artifacts with required fields (`profile_id`, `schema_version`, `host`, `port`, `use_https`, `http_get_uri`, `http_post_uri`, `user_agent`, `http_headers`). Ensure default profile mirrors current baseline config values and non-default profile exercises meaningful compatible variation.</action>
  <verify>python3 -m json.tool profiles/http/default-profile.json >/dev/null && python3 -m json.tool profiles/http/nondefault-profile.json >/dev/null</verify>
  <done>Profile artifacts exist, are JSON-valid, and clearly encode baseline + variant profile values.</done>
</task>

<task type="auto">
  <name>Task 2: Implement profile validation and rendering scripts</name>
  <files>generate-payload/validate_profile.py, generate-payload/render_profile_header.py</files>
  <action>Implement deterministic Python scripts to validate profile schema/constraints and render selected profile into build-consumable generated header/artifact. Validation must fail fast on missing/invalid fields and output stable diagnostics.</action>
  <verify>python3 generate-payload/validate_profile.py profiles/http/default-profile.json && python3 generate-payload/render_profile_header.py --profile profiles/http/default-profile.json --output implant/generated/profile_config.h --dry-run</verify>
  <done>Validation and rendering scripts support deterministic pass/fail behavior and are usable from generation workflow.</done>
</task>

<task type="auto">
  <name>Task 3: Wire profile selection into generation workflow</name>
  <files>CustomBeacon.cna, generate-payload/InsertListenerInfo.py</files>
  <action>Update generation flow so profile selection is explicit, defaults to baseline artifact, and runs validation/render before build. Keep legacy listener extraction behavior where needed, but remove dependence on tracked header edits for profile changes.</action>
  <verify>rg -n "validate_profile\.py|render_profile_header\.py|profile" CustomBeacon.cna generate-payload/InsertListenerInfo.py</verify>
  <done>Operator flow selects profile artifact and drives generated config path without manual source/header edits.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python3 -m json.tool profiles/http/default-profile.json` succeeds
- [ ] `python3 generate-payload/validate_profile.py profiles/http/default-profile.json` succeeds
- [ ] `python3 generate-payload/render_profile_header.py --profile profiles/http/default-profile.json --output implant/generated/profile_config.h --dry-run` succeeds
- [ ] Generation workflow references profile validation/render steps
</verification>

<success_criteria>

- All tasks completed
- Profile artifact contract established and validated
- Generation flow supports explicit profile selection per build target
- C2P-01 and C2P-03 are directly addressed without scope expansion

</success_criteria>

<output>
After completion, create `.planning/phases/02-http-s-profile-abstraction/02-01-SUMMARY.md`
</output>
